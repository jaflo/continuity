$(document).ready(function(){function t(t){$(t).not(".master").each(function(){var t=$(this);t.click(function(){t.height("auto");var e=t.outerHeight();t.find(".more").show();var a=t.outerHeight();t.height(e),t.addClass("highlighed").height(a)})})}function e(e){var i=$(".master.piece").clone();i.removeClass("master").addClass("hidden").attr("id","piece"+e.shortID),i.find(".author").attr("href","/user/"+e.author.id).find("i").text(e.author.emoji),i.find(".author").find("span").text("by "+e.author.display),i.toggleClass("starred",e.starred),i.find(".content").text(e.content);var n=$("#story").outerHeight();t(i),$("#story").append(i);var o=$("#story").outerHeight(),s=$("#story .piece").last();return $("#story").height(n).outerHeight(),$("#story").height(o),$("html, body").stop().animate({scrollTop:s.offset().top-200},300,"swing"),a(e.shortID),setTimeout(function(){s.removeClass("hidden"),$("#story").height("auto")},300),$("#next .status").text("restoring..."),p&&c.val(localStorage.getItem("save_"+r)||"").change(),e.storyfragment&&c.val(e.storyfragment||"").change(),$("#next .status").text("ready"),!1}function a(t){r=t,u.find("input[name=parent]").val(t),s?history.replaceState({},t,"/story/"+t):(s=!0,history.pushState({},t,"/story/"+t))}function i(t,e){var a=$(":focus"),i=$("#message");i.find(".contents").html(t),i.find(".header span").text(e||"Heyo!"),i.find(".box").removeClass("enter exit"),i.fadeIn(100),i.find(".box").addClass("enter"),i.find("button").focus(),i.find(".close").click(function(){i.find(".box").on("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){i.find(".box").off(),i.fadeOut(100)}).addClass("exit"),a.focus()})}var n,o=!0,s=!1,r=location.pathname.length>4?location.pathname.replace("/story/",""):"00000",l=$(".getfocus"),d=0,u=$("#next"),c=u.find("textarea"),f=c.innerHeight(),h="",g="change keyup keydown keypress",p="undefined"!=typeof Storage;for($("#radial"),new Date;l.val()&&d<10;)l=l.nextAll("input, select, textarea").first(),d++;l.focus(),$("time").timeago(),$(document).ajaxError(function(t,e){console.log(e),0==e.status&&i("Check your internet connection.","Unable to connect")}),$("#login, #signup").submit(function(t){if($(this).find("button").attr("disabled"))t.preventDefault();else{var e=$("<ul>"),a=0;$(this).children("input").each(function(){$(this).val()||(e.append($("<li>").text($("label[for="+$(this).attr("name")+"]").text().toLowerCase())),a++)}),a?(i($("<div>").text("You did not enter anything for").append(e),"Missing information"),t.preventDefault()):$(this).find("button").attr("disabled","disabled")}}),c.on(g,function(t){var e=$(this).val();if(h!=e){u.toggleClass("hastext",e.length>0),$("main").append($("<div id=tester class=inputlike>").text(e));var a=$("#tester").innerHeight()+30;c.height(a>f?a:""),$("#tester").remove(),t.isTrigger||(clearTimeout(n),$("#next .status").text("waiting"),n=setTimeout(function(){""==e?($("#next .status").text("clearing..."),p&&localStorage.removeItem("save_"+r),$.post("/savefragment",$("#next").serialize(),function(t){"failed"==t.status?($("#next .status").text("failed"),i(t.message,"Clear failed")):$("#next .status").text("cleared")},"json").fail(function(){$("#next .status").text("failed")})):($("#next .status").text("saving..."),p&&localStorage.setItem("save_"+r,e),$.post("/savefragment",$("#next").serialize(),function(t){"failed"==t.status?($("#next .status").text("failed"),i(t.message,"Save failed")):$("#next .status").text("saved")},"json").fail(function(){$("#next .status").text("failed")}))},1e3))}h=e}),$("#next .status").text("restoring..."),p&&c.val(localStorage.getItem("save_"+r)||"").change(),$("#next .status").text("ready"),u.submit(function(t){$(this).find("button").attr("disabled")||(c.val().length>0?($.post("/create",$("#next").serialize(),function(t){u.find("textarea, button").removeAttr("disabled"),"failed"==t.status?i(t.message,"Failed to create"):(c.val(""),p&&localStorage.removeItem("save_"+r),e(t.data))},"json").fail(function(){u.find("textarea, button").removeAttr("disabled")}),u.find("button").attr("disabled","disabled")):($.get("/next",{parent:r},function(t){u.find("textarea, button").removeAttr("disabled"),"failed"==t.status?i(t.message,"Failed to load"):e(t.data)},"json").fail(function(){u.find("textarea, button").removeAttr("disabled")}),u.find("button").attr("disabled","disabled"))),t.preventDefault()}),$(window).scroll(function(){var t=$(window);!o&&t.scrollTop()+t.height()>$("#editor").offset().top+60&&(o=!0)}).on("popstate",function(t){window.location.reload()}),t("#story .piece"),$("#emojipicker").length>0&&($("#emoji").attr("type","hidden"),$("#emojipicker").show(),$.getJSON("/lib/emojimap.json",function(t){delete t.information;var e=Object.keys(t),a=$("#emoji").val()?"":e[e.length*Math.random()<<0],i=$("#emojipicker .results").removeClass("loading").empty(),n="",o=$("#emoji").val();for(var s in t){var r=$("<div>").text(t[s]);r=$("<div>").append(r).attr("title",s.replace(/_/g," ")).click(function(t){$("#emojipicker .results > div").removeClass("selected"),$(this).addClass("selected"),$("#emoji").val($(this).text()),$("#emojipicker .preview").text($(this).text()),t.isTrigger||$("#emojisearch").val($(this).attr("title"))}),i.append(r),s!=a&&t[s]!=o||(r.click(),i.scrollTop(9999999),$("#emojisearch").val(s.replace(/_/g," ")))}n=a.replace(/_/g," "),i.scrollTop()>50&&i.scrollTop(i.scrollTop()+i.outerHeight()/2),$("#emojisearch").on(g,function(){var t=$(this).val();t!=n&&(t.length>0?$("#emojipicker .results > div").hide().each(function(){var e=$(this);(e.text()+e.attr("title")).indexOf(t)>-1&&e.show()}):$("#emojipicker .results > div").show(),n=t)})}))}),$(".inputlike").find("textarea, input, button").focus(function(){$(this).parents(".inputlike").addClass("focus")}).blur(function(){$(this).parents(".inputlike").removeClass("focus")});