$(document).ready(function(){function t(t){$(t).not(".master").each(function(){var t=$(this);t.mousedown(function(i){b.removeClass("larger"),b.is(":visible")?a():$(i.target).is("a, a *")||1!=i.which||e(i.pageX-parseInt($("#wrapper").css("padding-left")),i.pageY,t)}).on("touchstart",function(i){b.addClass("larger"),b.is(":visible")?a():$(i.target).is("a, a *")||e(i.originalEvent.touches[0].pageX-2*parseInt($("#wrapper").css("padding-left")),i.originalEvent.touches[0].pageY,t)}).find(".options a").focus(function(){t.addClass("hover")}).blur(function(){t.removeClass("hover")})})}function e(t,e,i){y=new Date,$("body").addClass("dragging");var n=i.attr("id").replace("piece","");b.find("a, div").unbind().on("mouseup touchend",function(){new Date-y>300?$(this).click():$("body").removeClass("dragging")}).click(function(){a()}),$(document).unbind("mouseup touchend").on("mouseup touchend",function(t){new Date-y>300&&!$(t.target).is("#radial, #radial *")&&a()}),b.find(".close").click(a),b.find(".star").click(function(t){var e=$(this);$.post(e.attr("href"),{id:n},function(t){"failed"==t.status?s(t.message,"Failed to star"):i.toggleClass("starred",t.data.starred)},"json"),t.preventDefault()}).attr("href","/"+(i.hasClass("starred")?"unstar":"star")).find("i").removeClass().addClass("icon-star"+(i.hasClass("starred")?"_border":"")),b.find(".rewind").click(function(t){l?window.location.replace("/story/"+n):window.location="/story/"+n,t.preventDefault()}).attr("href","/story/"+n),b.find(".author").click(function(t){window.location=$(this).attr("href"),t.preventDefault()}).attr("href",i.find(".author").attr("href")),b.find(".info").click(function(t){var e=i.outerHeight();i.append($("<div>").addClass("injected hidden").text("test"));var a=i.outerHeight();i.height(e),i.addClass("highlighed").height(a),setTimeout(function(){i.find(".injected").removeClass("hidden")},300),t.preventDefault()}).attr("href",i.find(".author").attr("href")),b.hide().addClass("collapsed").css({top:e,left:t}).outerWidth(),b.show().removeClass("collapsed"),clearTimeout(r)}function a(){$("body").removeClass("dragging"),b.addClass("collapsed"),r=setTimeout(function(){b.hide()},500)}function i(e){var a=$(".master.piece").clone();a.removeClass("master").addClass("hidden").attr("id","piece"+e.shortID),a.find(".author").attr("href","/user/"+e.author.id).find("i").text(e.author.emoji),a.find(".author").find("span").text("by "+e.author.display),a.toggleClass("starred",e.starred),a.find(".content").text(e.content);var i=$("#story").outerHeight();t(a),$("#story").append(a);var s=$("#story").outerHeight(),o=$("#story .piece").last();return $("#story").height(i).outerHeight(),$("#story").height(s),$("html, body").stop().animate({scrollTop:o.offset().top-200},300,"swing"),n(e.shortID),setTimeout(function(){o.removeClass("hidden"),$("#story").height("auto")},300),$("#next .status").text("restoring..."),x&&p.val(localStorage.getItem("save_"+c)||"").change(),e.storyfragment&&p.val(e.storyfragment||"").change(),$("#next .status").text("ready"),!1}function n(t){c=t,h.find("input[name=parent]").val(t),l?history.replaceState({},t,"/story/"+t):(l=!0,history.pushState({},t,"/story/"+t))}function s(t,e){var a=$(":focus"),i=$("#message");i.find(".contents").html(t),i.find(".header span").text(e||"Heyo!"),i.find(".box").removeClass("enter exit"),i.fadeIn(100),i.find(".box").addClass("enter"),i.find("button").focus(),i.find(".close").click(function(){i.find(".box").on("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){i.find(".box").off(),i.fadeOut(100)}).addClass("exit"),a.focus()})}for(var o,r,d=!0,l=!1,c=location.pathname.length>4?location.pathname.replace("/story/",""):"00000",u=$(".getfocus"),f=0,h=$("#next"),p=h.find("textarea"),g=p.innerHeight(),v="",m="change keyup keydown keypress",x="undefined"!=typeof Storage,b=$("#radial"),y=new Date;u.val()&&f<10;)u=u.nextAll("input, select, textarea").first(),f++;u.focus(),$("time").timeago(),$(document).ajaxError(function(t,e){console.log(e),0==e.status&&s("Check your internet connection.","Unable to connect")}),$("#login, #signup").submit(function(t){if($(this).find("button").attr("disabled"))t.preventDefault();else{var e=$("<ul>"),a=0;$(this).children("input").each(function(){$(this).val()||(e.append($("<li>").text($("label[for="+$(this).attr("name")+"]").text().toLowerCase())),a++)}),a?(s($("<div>").text("You did not enter anything for").append(e),"Missing information"),t.preventDefault()):$(this).find("button").attr("disabled","disabled")}}),p.on(m,function(t){var e=$(this).val();if(v!=e){h.toggleClass("hastext",e.length>0),$("main").append($("<div id=tester class=inputlike>").text(e));var a=$("#tester").innerHeight()+30;p.height(a>g?a:""),$("#tester").remove(),t.isTrigger||(clearTimeout(o),$("#next .status").text("waiting"),o=setTimeout(function(){""==e?($("#next .status").text("clearing..."),x&&localStorage.removeItem("save_"+c),$.post("/savefragment",$("#next").serialize(),function(t){"failed"==t.status?($("#next .status").text("failed"),s(t.message,"Clear failed")):$("#next .status").text("cleared")},"json").fail(function(){$("#next .status").text("failed")})):($("#next .status").text("saving..."),x&&localStorage.setItem("save_"+c,e),$.post("/savefragment",$("#next").serialize(),function(t){"failed"==t.status?($("#next .status").text("failed"),s(t.message,"Save failed")):$("#next .status").text("saved")},"json").fail(function(){$("#next .status").text("failed")}))},1e3))}v=e}),$("#next .status").text("restoring..."),x&&p.val(localStorage.getItem("save_"+c)||"").change(),$("#next .status").text("ready"),h.submit(function(t){$(this).find("button").attr("disabled")||(p.val().length>0?($.post("/create",$("#next").serialize(),function(t){h.find("textarea, button").removeAttr("disabled"),"failed"==t.status?s(t.message,"Failed to create"):(p.val(""),x&&localStorage.removeItem("save_"+c),i(t.data))},"json").fail(function(){h.find("textarea, button").removeAttr("disabled")}),h.find("button").attr("disabled","disabled")):($.get("/next",{parent:c},function(t){h.find("textarea, button").removeAttr("disabled"),"failed"==t.status?s(t.message,"Failed to load"):i(t.data)},"json").fail(function(){h.find("textarea, button").removeAttr("disabled")}),h.find("button").attr("disabled","disabled"))),t.preventDefault()}),$(window).scroll(function(){var t=$(window);!d&&t.scrollTop()+t.height()>$("#editor").offset().top+60&&(d=!0)}).on("popstate",function(t){window.location.reload()}),t("#story .piece"),b.show().hide(),$("#emojipicker").length>0&&($("#emoji").attr("type","hidden"),$("#emojipicker").show(),$.getJSON("/lib/emojimap.json",function(t){delete t.information;var e=Object.keys(t),a=$("#emoji").val()?"":e[e.length*Math.random()<<0],i=$("#emojipicker .results").removeClass("loading").empty(),n="",s=$("#emoji").val();for(var o in t){var r=$("<div>").text(t[o]);r=$("<div>").append(r).attr("title",o.replace(/_/g," ")).click(function(t){$("#emojipicker .results > div").removeClass("selected"),$(this).addClass("selected"),$("#emoji").val($(this).text()),$("#emojipicker .preview").text($(this).text()),t.isTrigger||$("#emojisearch").val($(this).attr("title"))}),i.append(r),o!=a&&t[o]!=s||(r.click(),i.scrollTop(9999999),$("#emojisearch").val(o.replace(/_/g," ")))}n=a.replace(/_/g," "),i.scrollTop()>50&&i.scrollTop(i.scrollTop()+i.outerHeight()/2),$("#emojisearch").on(m,function(){var t=$(this).val();t!=n&&(t.length>0?$("#emojipicker .results > div").hide().each(function(){var e=$(this);(e.text()+e.attr("title")).indexOf(t)>-1&&e.show()}):$("#emojipicker .results > div").show(),n=t)})}))}),$(".inputlike").find("textarea, input, button").focus(function(){$(this).parents(".inputlike").addClass("focus")}).blur(function(){$(this).parents(".inputlike").removeClass("focus")});